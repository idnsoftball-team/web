<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IDN SOFTBALL | 印第安慢壘隊</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            /* 日本火腿鬥士隊風格配色 */
            --idn-blue: #00558F; /* Fighters Blue */
            --idn-gold: #B4975A; /* Fighters Gold */
            --idn-black: #222222;
            --idn-white: #ffffff;
            --idn-gray: #f4f4f4;
            --text-main: #333;
            --card-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Roboto', 'Noto Sans TC', sans-serif; }
        body { background-color: var(--idn-gray); color: var(--text-main); line-height: 1.6; }

        /* --- 導航列 --- */
        nav {
            background: var(--idn-blue);
            color: white;
            padding: 1rem 5%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        .logo { font-size: 1.5rem; font-weight: 800; letter-spacing: 1px; color: var(--idn-gold); }
        .nav-links a { color: white; text-decoration: none; margin-left: 20px; font-weight: 500; transition: color 0.3s; }
        .nav-links a:hover { color: var(--idn-gold); }

        /* --- Hero Section --- */
        header {
            height: 60vh;
            background-color: #333;
            background-size: cover;
            background-position: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            color: white;
            position: relative;
        }
        header::after {
            content: ''; position: absolute; top:0; left:0; width:100%; height:100%;
            background: rgba(0,85,143, 0.4); /* 藍色遮罩 */
        }
        .hero-content { position: relative; z-index: 1; }
        .hero-title { font-size: 3.5rem; font-weight: 900; text-transform: uppercase; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); }
        .hero-subtitle { font-size: 1.2rem; letter-spacing: 3px; color: var(--idn-gold); margin-top: 10px; font-weight: bold; }

        /* --- 通用區塊 --- */
        section { padding: 4rem 5%; max-width: 1200px; margin: 0 auto; }
        .section-title {
            text-align: center;
            font-size: 2rem;
            color: var(--idn-blue);
            margin-bottom: 3rem;
            position: relative;
            font-weight: 800;
        }
        .section-title::after {
            content: ''; display: block; width: 60px; height: 4px;
            background: var(--idn-gold); margin: 10px auto 0;
        }

        /* --- 賽程表 --- */
        .schedule-controls { text-align: right; margin-bottom: 1rem; }
        .btn-main {
            background: var(--idn-gold); color: white; border: none; padding: 10px 20px;
            border-radius: 4px; cursor: pointer; font-weight: bold; transition: 0.2s;
        }
        .btn-main:hover { background: #9c824a; }
        
        .schedule-table-container { overflow-x: auto; background: white; border-radius: 8px; box-shadow: var(--card-shadow); }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: var(--idn-blue); color: white; font-weight: 600; }
        tr:hover { background-color: #f9f9f9; }
        
        /* --- YouTube 櫥窗 (Carousel) --- */
        .video-scroller {
            display: flex; overflow-x: auto; gap: 20px; padding-bottom: 20px;
            scroll-behavior: smooth;
        }
        .video-card {
            min-width: 300px; background: black; border-radius: 8px; overflow: hidden;
            box-shadow: var(--card-shadow); cursor: pointer; position: relative;
            transition: transform 0.3s;
        }
        .video-card:hover { transform: translateY(-5px); }
        .video-thumb { width: 100%; aspect-ratio: 16/9; object-fit: cover; opacity: 0.8; }
        .video-card:hover .video-thumb { opacity: 1; }
        .video-title {
            padding: 10px; color: white; font-size: 0.9rem;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .play-icon {
            position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%);
            font-size: 3rem; color: rgba(255,255,255,0.8); pointer-events: none;
        }

        /* --- 球員介紹 (Grid) --- */
        .players-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
        }
        .player-card {
            background: white; border-radius: 8px; overflow: hidden;
            box-shadow: var(--card-shadow); text-align: center;
            border-top: 4px solid var(--idn-gold);
            transition: transform 0.3s;
        }
        .player-card:hover { transform: translateY(-5px); }
        .player-img-container {
            width: 100%; height: 200px; background: #ddd; overflow: hidden;
            display: flex; align-items: center; justify-content: center;
            color: #888;
        }
        .player-img { width: 100%; height: 100%; object-fit: cover; }
        .player-info { padding: 15px; }
        .player-number { font-size: 1.5rem; font-weight: 900; color: var(--idn-blue); display: block;}
        .player-name { font-size: 1.2rem; font-weight: 700; margin: 5px 0; }
        .player-pos { font-size: 0.9rem; color: #666; background: #eee; padding: 2px 8px; border-radius: 10px;}

        /* --- Modal (彈窗) --- */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 2000; align-items: center; justify-content: center;
        }
        .modal-content {
            background: white; padding: 2rem; border-radius: 8px; width: 90%; max-width: 500px;
            position: relative;
        }
        .close-modal { position: absolute; top: 10px; right: 15px; font-size: 1.5rem; cursor: pointer; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        
        /* Video Lightbox */
        .video-modal-content { background: black; padding: 0; width: 90%; max-width: 800px; aspect-ratio: 16/9; }
        iframe { width: 100%; height: 100%; border: none; }

        /* Loading Overlay */
        #loader {
            position: fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:9999;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
        }
        .loader-spinner { border: 5px solid #f3f3f3; border-top: 5px solid var(--idn-blue); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <div id="loader">
        <div class="loader-spinner"></div>
        <p style="margin-top:10px; font-weight:bold; color:var(--idn-blue);">載入數據中...</p>
    </div>

    <nav>
        <div class="logo">IDN SOFTBALL</div>
        <div class="nav-links">
            <a href="#schedule">賽程</a>
            <a href="#videos">影音</a>
            <a href="#players">球員</a>
        </div>
    </nav>

    <header id="hero-section">
        <div class="hero-content">
            <div class="hero-title">印第安慢壘隊</div>
            <div class="hero-subtitle">WE LOVE SOFTBALL</div>
        </div>
    </header>

    <section id="schedule">
        <h2 class="section-title">賽程資訊</h2>
        <div class="schedule-controls">
            <button class="btn-main" onclick="openAdminModal()">
                <i class="fas fa-edit"></i> 編輯賽程
            </button>
        </div>
        <div class="schedule-table-container">
            <table>
                <thead>
                    <tr>
                        <th width="20%">日期</th>
                        <th width="15%">時間</th>
                        <th width="25%">球場</th>
                        <th width="40%">備註 / 對手</th>
                    </tr>
                </thead>
                <tbody id="schedule-body">
                    </tbody>
            </table>
        </div>
    </section>

    <section id="videos" style="background: #111; color: white;">
        <h2 class="section-title" style="color:white;">精彩影音</h2>
        <div class="video-scroller" id="video-container">
            </div>
    </section>

    <section id="players">
        <h2 class="section-title">球員介紹</h2>
        <div class="players-grid" id="players-container">
            </div>
    </section>

    <div id="admin-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('admin-modal')">&times;</span>
            <h3 style="margin-bottom:20px; color:var(--idn-blue);">新增賽程</h3>
            
            <div id="password-step">
                <div class="form-group">
                    <label>管理密碼</label>
                    <input type="password" id="admin-password" placeholder="請輸入密碼">
                </div>
                <button class="btn-main" onclick="verifyPassword()" style="width:100%">驗證</button>
            </div>

            <div id="form-step" style="display:none;">
                <div class="form-group">
                    <label>比賽日期</label>
                    <input type="date" id="match-date">
                </div>
                <div class="form-group">
                    <label>比賽時間</label>
                    <input type="time" id="match-time">
                </div>
                <div class="form-group">
                    <label>球場 (可選或直接輸入新球場)</label>
                    <input list="stadiums-list" id="match-location" placeholder="選擇或輸入新球場...">
                    <datalist id="stadiums-list">
                        </datalist>
                </div>
                <button class="btn-main" onclick="submitSchedule()" id="submit-btn" style="width:100%">新增賽程</button>
            </div>
        </div>
    </div>

    <div id="video-modal" class="modal">
        <div class="modal-content video-modal-content">
            <span class="close-modal" onclick="closeVideo()" style="color:white; right: -30px; top: -30px;">&times;</span>
            <iframe id="yt-player" src="" allow="autoplay; encrypted-media" allowfullscreen></iframe>
        </div>
    </div>

    <script>
        // --- 設定區 ---
        const GAS_URL = "https://script.google.com/macros/s/AKfycbxAKNH-6eV-cwXZBqd_qyLe9MvCVQ6XELSfEzu8or7ds8niOAWRvxmNUnEfuls3Otd3dg/exec";
        const CHANNEL_ID = "UC_T7bgZJQEKNUPYSBVEDUrg";
        
        // 全局變數
        let globalData = {};

        // --- 初始化 ---
        window.onload = async function() {
            try {
                // 1. 抓取 GAS 資料
                const res = await fetch(GAS_URL + "?action=get_all_data");
                const data = await res.json();
                
                if(data.error) throw new Error(data.error);
                
                globalData = data;
                renderApp(data);

                // 2. 抓取 YouTube (使用 RSS 轉 JSON 服務避免 API Key 問題)
                fetchYouTubeVideos();

            } catch (e) {
                alert("讀取資料失敗: " + e.message);
            } finally {
                document.getElementById('loader').style.display = 'none';
            }
        };

        // --- 渲染功能 ---
        function renderApp(data) {
            // 1. Hero
            if (data.hero.bgUrl) {
                document.getElementById('hero-section').style.backgroundImage = `url('${data.hero.bgUrl}')`;
            }
            
            // 2. Schedule
            const tbody = document.getElementById('schedule-body');
            tbody.innerHTML = data.schedules.map(s => `
                <tr>
                    <td>${s.date}</td>
                    <td>${s.time}</td>
                    <td><strong>${s.location}</strong></td>
                    <td>-</td> 
                </tr>
            `).join('');

            // 填充球場選單
            const dataList = document.getElementById('stadiums-list');
            dataList.innerHTML = data.stadiums.map(loc => `<option value="${loc}">`).join('');

            // 3. Players
            const pContainer = document.getElementById('players-container');
            pContainer.innerHTML = data.players.map(p => `
                <div class="player-card">
                    <div class="player-img-container">
                        ${p.photo ? `<img src="${p.photo}" class="player-img">` : `<i class="fas fa-user fa-3x"></i>`}
                    </div>
                    <div class="player-info">
                        <span class="player-number">#${p.number}</span>
                        <h3 class="player-name">${p.name}</h3>
                        <span class="player-pos">${p.positions || '未登錄'}</span>
                    </div>
                </div>
            `).join('');
        }

        async function fetchYouTubeVideos() {
            // 使用 rss2json 繞過跨域問題讀取頻道 RSS
            const rssUrl = `https://www.youtube.com/feeds/videos.xml?channel_id=${CHANNEL_ID}`;
            const apiUrl = `https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(rssUrl)}`;
            
            try {
                const res = await fetch(apiUrl);
                const data = await res.json();
                
                if(data.items) {
                    const container = document.getElementById('video-container');
                    container.innerHTML = data.items.map(item => {
                        // 提取 Video ID
                        const videoId = item.link.split('v=')[1];
                        return `
                            <div class="video-card" onclick="playVideo('${videoId}')">
                                <img src="https://img.youtube.com/vi/${videoId}/hqdefault.jpg" class="video-thumb">
                                <i class="fas fa-play-circle play-icon"></i>
                                <div class="video-title">${item.title}</div>
                            </div>
                        `;
                    }).join('');
                }
            } catch(e) {
                console.error("YouTube Load Error", e);
            }
        }

        // --- 互動功能 ---
        function openAdminModal() {
            document.getElementById('admin-modal').style.display = 'flex';
            // 重置狀態
            document.getElementById('password-step').style.display = 'block';
            document.getElementById('form-step').style.display = 'none';
            document.getElementById('admin-password').value = '';
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        // 密碼驗證
        function verifyPassword() {
            const pwd = document.getElementById('admin-password').value;
            // 這裡做個簡單的前端檢查，後端會再驗證一次
            if (pwd === 'idnsoftball1991') {
                document.getElementById('password-step').style.display = 'none';
                document.getElementById('form-step').style.display = 'block';
            } else {
                alert('密碼錯誤！');
            }
        }

        // 提交賽程
        async function submitSchedule() {
            const btn = document.getElementById('submit-btn');
            const date = document.getElementById('match-date').value;
            const time = document.getElementById('match-time').value;
            const location = document.getElementById('match-location').value;
            const password = document.getElementById('admin-password').value;

            if(!date || !location) { alert('請填寫完整資訊'); return; }

            btn.innerText = '處理中...';
            btn.disabled = true;

            const payload = {
                action: "add_schedule",
                password: password,
                payload: { date, time, location }
            };

            try {
                // 使用 fetch POST 發送資料給 GAS
                // 注意：GAS Web App POST 會有 CORS 問題，通常需要用 'no-cors' 
                // 但 'no-cors' 拿不到回傳值。
                // 這裡使用標準方法，若 GAS 設為 Anyone 權限，通常可由 fetch 處理 redirect 拿到結果
                
                const res = await fetch(GAS_URL, {
                    method: 'POST',
                    mode: 'no-cors', // 關鍵：這讓瀏覽器允許發送，但我們拿不到回應文字
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                // 因為 no-cors 拿不到回應，我們假設成功並重整
                alert('請求已發送！請稍待幾秒後重新整理頁面查看。');
                location.reload();

            } catch(e) {
                alert('發生錯誤: ' + e);
                btn.innerText = '新增賽程';
                btn.disabled = false;
            }
        }

        // 影片播放
        function playVideo(id) {
            const modal = document.getElementById('video-modal');
            const iframe = document.getElementById('yt-player');
            iframe.src = `https://www.youtube.com/embed/${id}?autoplay=1`;
            modal.style.display = 'flex';
        }

        function closeVideo() {
            const modal = document.getElementById('video-modal');
            const iframe = document.getElementById('yt-player');
            iframe.src = '';
            modal.style.display = 'none';
        }

        // 點擊視窗外關閉
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = "none";
                if(event.target.id === 'video-modal') {
                    document.getElementById('yt-player').src = '';
                }
            }
        }
    </script>
</body>
</html>